YUI.add("scrappy-aviary",function(e){typeof document!="undefined"&&(document.domain="flickr.com");var t=e.Views.dialogs["dialog-modal"],n,r,i;i={debug:!1,redirect:{created:"/photos/{{pathAlias}}/{{photoId}}"},aviary:{frameUrl:"//flickr.aviary.com/default.aspx",locale:"en-us"},css:{connecting:"c-aviary-state-connecting",popups:".c-aviary-popups",uploading:"c-aviary-state-uploading"}},r=e.merge(e.flutil,{log:function(){if(!i.debug||!console.log.apply)return;var e=[].slice.call(arguments);e.unshift("SHARE"),r.dump.apply(null,e)}}),n=e.namespace("Views").scrappyAviary=e.Base.create("scrappyAviary",t,[],{initializer:function(n){return t.prototype.initializer.call(this,n),this.set("user",this.appContext.getViewer().signedIn?{}:null),this.set("owner",this.get("photo").getValue("owner")),e.Views.dialog.registerView(this,this.get("photo").getValue("id")),this.initialize(),this},initialize:function(){this.on("rendered",this.renderFrame,this),this._aviaryEvents=[["load",function(e){return e.pageLoaded}],["edited",function(e){return e.type==="replace"&&e.editSuccessful}],["created",function(e){return e.type==="new"&&e.editSuccessful}]],this._aviaryEvents.handleCommand=this.handleCommand.bind(this),window.addEventListener("message",this._aviaryEvents.handleCommand),this.attachEditorEvents()},attachEditorEvents:function(){var e=this;this.on("authorize",function(t){e.confirmAuthorize(function(){t.authForm.submit(),e.show()})}),this.on("load",function(t){e.get("container").removeClass(i.css.connecting)}),this.on("edited",function(t){e.get("container").addClass(i.css.uploading),clearTimeout(e._aviaryEvents.editedTimer),e._aviaryEvents.editedTimer=setTimeout(function(){document.location.reload()},1e3)}),this.on("created",function(t){e.get("container").addClass(i.css.uploading),clearTimeout(e._aviaryEvents.createdTimer),e._aviaryEvents.createdTimer=setTimeout(function(){var n=i.redirect.created;n=n.replace("{{pathAlias}}",e.get("owner").getValue("pathAlias")),n=n.replace("{{photoId}}",t.photo_id),document.location=n},1e3)})},handleCommand:function(e){var t,n,r;try{t=JSON.parse(e.data)}catch(i){t={}}for(n=0,r=this._aviaryEvents.length;n<r;n++)if(this._aviaryEvents[n][1](t))return this.fire(this._aviaryEvents[n][0],t)},renderFrame:function(){var t,n,r,s,o,u,a,f,l,c=this;this.get("container").addClass(i.css.connecting),l={width:this.get("width"),height:this.get("height")},u=this.get("photo").getSizeToFit(l).url,f=this.get("photo").getValue("sizes");for(a in f)if(f[a].url===u)break;t=e.flutil.template("{{baseUrl}}?id={{photoId}}&intl={{locale}}&big=1&viewport_width={{width}}&viewport_height={{height}}&image_size={{imageSize}}&cachebust=6",{baseUrl:i.aviary.frameUrl,locale:i.aviary.locale,width:parseInt(this.get("width"),10),height:parseInt(this.get("height"),10),imageSize:a,photoId:this.get("photo").getValue("id")}),this.iframe=e.Node.create("<iframe/>"),this.iframe.setAttribute("seamless","seamless"),this.iframe.setAttribute("frameborder","0"),this.iframe.setAttribute("scrolling","no"),this.iframe.setAttribute("marginheight","0"),this.iframe.setAttribute("marginwidth","0"),this.iframe.setStyles({width:this.get("width"),height:this.get("height")}),this.iframe.set("src",t),this.set("content",this.iframe),this.renderContent(),n=this.iframe.getDOMNode(),r=function(e,t,n,i){if(!--i)return;if(n&&n())return;if(t())return e();setTimeout(function(){r(e,t,n,i)},100)},s=function(){r(o,function(){return n.contentDocument.querySelector('form[method="post"]')},function(){return!n.contentDocument.location.host},150)},o=function(){var e=n.contentDocument.querySelector('form[method="post"]'),t={};Array.prototype.slice.call(e.querySelectorAll('input[type="hidden"]')).forEach(function(e){t[e.name]=e.value}),c.fire("authorize",{authForm:e,authData:t,authAction:e.action,authMethod:e.method})},r(s,function(){try{return/authorize_aviary/.test(n.contentDocument.location.href)}catch(e){return!1}},function(){return!1},150)},activate:function(){var e,n=this;return t.prototype.activate.call(this),e={":cancel":function(e,t){e.halt(),n.destroy()}},this.attachEvents(e),this},confirmAuthorize:function(t){var n=this,r,i;r=new e.Views["confirmation-dialog-view"]({appContext:this.appContext,title:"Aviary Photo Editor wants to link to your Flickr account",icon:"ui-icon-modal-warning",content:"By authorizing this link, you'll allow Aviary Photo Editor to: <ul><li class='aviary-dialog-list'>Access your Flickr account (including private content)</li><li  class='aviary-dialog-list'>Upload, Edit, and Replace photos and videos in your account </li><li class='aviary-dialog-list'>Interact with other members' photos and videos (comment, add notes, favorite).</li> </ul>Aviary Photo Editor will not have permission to delete photos and videos from your account"}),r.render(),r.activate(),i=r.get("container"),i.one(".dialog-icon").setStyle("marginTop","50px"),r.registerEventHandler(i.one(".ui-dialog-button-confirm").on("click",function(){t(),n.confirmAuthDialog.close(),n.confirmAuthDialog.destroy()})),this.confirmAuthDialog=e.Views.dialog.getNewInstance("dialog-modal",{content:r.get("container"),appContext:this.appContext,dialogClass:"scrappy-dialog"}),this.confirmAuthDialog.show(!1,{hideOthers:!0})},confirmCancel:function(){var t=this,n,r;n=new e.Views["confirmation-dialog-view"]({appContext:this.appContext,title:"Confirm Cancel",icon:"ui-icon-modal-warning",content:"If you close this window, all the changes you made to this photo will be lost. Are you sure you want to continue?",confirmButtonLabel:"Yes, go ahead"}),n.render(),n.activate(),r=n.get("container"),n.registerEventHandler(r.one(".ui-dialog-button-confirm").on("click",function(){t.confirmCancelDialog.close(),t.confirmCancelDialog.destroy()})),this.fire("viewEvent","getDialogOffset",function(r){t.confirmCancelDialog=e.Views.dialog.getNewInstance("dialog-modal",{content:n.get("container"),appContext:t.appContext,offsetLeft:r,dialogClass:"scrappy-dialog"}),t.confirmCancelDialog.show()})},destroy:function(
){this.close(),this._aviaryEvents&&(window.removeEventListener("message",this._aviaryEvents.handleCommand),this._aviaryEvents.handleCommand=null),this.iframe&&this.iframe.set("src","about:blank"),this.iframe=null,t.prototype.destroy.call(this)}},{ATTRS:{template:{value:"aviary"},attrs:{value:{}},photo:{value:null},hideOnCurtainClick:{value:!1}}})},"@VERSION@",{requires:["flutil","dialog","flickr-promise","hermes-template-aviary","hermes-template-aviary-dialog-authorize"],optional:["photo-models","aviary-css"]});
YUI.add("hermes-template-feather-aviary-save-dialog",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+='<div class="save-aviary-changes">\n 	<button class="alt aviary-upload">',u={hash:{intlName:"aviary.SAVE"},data:i},s+=f((o=n.intlMessage||t.intlMessage,o?o.call(t,u):a.call(t,"intlMessage",u)))+'</button>\n 	<button class="aviary-replace">',u={hash:{intlName:"common.REPLACE"},data:i},s+=f((o=n.intlMessage||t.intlMessage,o?o.call(t,u):a.call(t,"intlMessage",u)))+"</button>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/feather-aviary-save-dialog",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("feather-aviary-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.nsid=e.nsid,this.photoId=e.photoId,this.closeUrl=e.closeUrl,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},loadState:function(){var t=this,n=new e.FlickrPromise({photo:t.appContext.getModel("photo-models",t.photoId)});return n.then(function(e){t.set("photo",e.photo)})},buildContainer:function(){return this},mapLanguage:function(e){var t={"de-DE":"de","en-US":"en","es-US":"es","fr-FR":"fr","id-ID":"id","it-IT":"it","ko-KR":"ko","pt-BR":"pt_BR","vi-VN":"vi","zh-Hant-HK":"zh_HANT"};return t[e]},responseFromAviaryFrame:function(t){var n="https:"+this.get("photo").getLargestSize().url,r="https:"+this.get("photo").getValue("sizes").o.url,i=e.guid(),s,o,u,a,f,l,c,h=this,p,d=/^https:\/\/s3.amazonaws.com\/hires.aviary.com\/k\/e387fafbf27235a7\/.+/,v="https://s.yimg.com",m={sendAuthParamsToiFrame:"Give new auth params",sendAuthParamsToPollAviaryJobStatus:"Give polling auth params",iFrameIsReady:"iFrame is ready",aviaryEditorClosed:"Aviary Editor is closed",aviaryError:"Error"},g;t.origin===v&&(t.data===m.iFrameIsReady&&this.handShakeIntervalRef||t.data===m.sendAuthParamsToiFrame||t.data===m.sendAuthParamsToPollAviaryJobStatus?(this.handShakeIntervalRef&&(clearInterval(this.handShakeIntervalRef),clearTimeout(this.iframeTimeoutRef),this.handShakeIntervalRef=!1,this.iframeTimeoutRef=!1),h.appContext.flickrAPI.callMethod("flickr.aviary.createSignature",{salt:i}).then(function(e){f=h.mapLanguage(h.appContext.lang),l=h.get("photo").getValue("rotation"),s=e.signature&&e.signature.apiKey?e.signature.apiKey:null,a=e.signature&&e.signature.content?e.signature.content:null,o=e.signature&&e.signature.timestamp?e.signature.timestamp.toString():null,u=e.signature&&e.signature.method?e.signature.method:null,t.data===m.iFrameIsReady?g="Editor setup":t.data===m.sendAuthParamsToiFrame?g="Save auth":t.data===m.sendAuthParamsToPollAviaryJobStatus&&(g="Polling auth"),p={purpose:g,originalPhotoURL:r,largestPhotoURL:n,salt:i,apiKey:s,signature:a,timeStamp:o,hashing:u,language:f,rotation:l},t.source.postMessage(p,v)},function(t){h.appContext.error("[feather-aviary-view] Error generating Signature for Aviary ("+t+")"),h.onError(h.intlMessage({intlName:"errors.ERROR_HAS_OCCURRED"})),e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.aviarySignature.creation.failure",title:"Aviary signature creation API Failure"},e.url("/beacon_flanal_reboot_event.gne"))})})):t.data===m.aviaryEditorClosed?this.aviaryDialog.close():t.data.indexOf("Error:")!==-1?(e.rapidTracker.beacon(h.name,"aviaryError"),h.appContext.error("[feather-aviary-view] Aviary Editor has returned an error: ("+t.data+")"),e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.aviaryEditor.failure",title:"Aviary Editor Failure"},e.url("/beacon_flanal_reboot_event.gne"))}),c=new e.Views.FluidModal({appContext:h.appContext,dismissOnOverlayClick:!0,showBodyLines:!1,showCancelButton:!0,showActionButton:!0,showCancelX:!0,title:this.intlMessage({intlName:"common.RETRY"}),message:this.intlMessage({intlName:"aviary.RETRY_DIALOG_MESSAGE"}),actionButtonLabel:this.intlMessage({intlName:"common.RETRY"})}),c.on("actionClick",function(c){h.appContext.flickrAPI.callMethod("flickr.aviary.createSignature",{salt:i}).then(function(e){s=e.signature&&e.signature.apiKey?e.signature.apiKey:null,a=e.signature&&e.signature.content?e.signature.content:null,o=e.signature&&e.signature.timestamp?e.signature.timestamp.toString():null,u=e.signature&&e.signature.method?e.signature.method:null,p={purpose:"Save auth",originalPhotoURL:r,largestPhotoURL:n,salt:i,apiKey:s,signature:a,timeStamp:o,hashing:u,language:f,rotation:l},t.source.postMessage(p,v)},function(t){h.appContext.error("[feather-aviary-view] Error generating Signature for Aviary ("+t+")"),h.onError(h.intlMessage({intlName:"errors.ERROR_HAS_OCCURRED"})),e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.aviarySignature.creation.failure",title:"Aviary signature creation API Failure"},e.url("/beacon_flanal_reboot_event.gne"))})})}),c.show()):d.test(t.data)&&h.saveFromAviary(t.data))},aviaryReplaceImage:function(t,n){var r=new FormData,i,s="https://up.flickr.com/services/replace",o,u,a=this;t.target.get("parentNode").addClass("balls"),t.target.get("parentNode").append("<span>"+this.intlMessage({intlName:"common.REPLACING"})+"...</span>"),r.append("api_key",e.config.flickr.api.site_key),r.append("csrf",e.config.flickr.csrf.token),r.append("external_image_link",n),r.append("photo_id",a.photoId),r.append("clone_meta_from_photo_id",1),i=new XMLHttpRequest,i.open("POST",s,!0),i.withCredentials=!0,o=function(t){var n=typeof t=="object"?t.target.statusText:t+"";a.appContext.error("[feather-aviary-view] aviary-edit: Error replacing the Image ("+n+")"),a.onError(a.intlMessage({intlName:"errors.ERROR_REPLACING"})),e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.replace.failure",title:"Replace API Failure"},e.url("/beacon_flanal_reboot_event.gne"))})},u=function(t){var n,r,i;try{i=document.createElement("div"),i.innerHTML=t.target.responseText,r=i.getElementsByTagName("rsp")[0]||"",r&&(r=r.getAttribute("stat")||""),n=i.getElementsByTagName("err")[0]||"",n&&(n=n.getAttribute("msg")||"")}catch(s){r="",n=""}if(r!=="ok")return o((r||"empty")+": "+(n||"no message"));e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.replace.success",title:"Aviary Replace Image successful"},e.url("/beacon_flanal_reboot_event.gne"))}),document.location.reload()},i.addEventListener("load",u),i.addEventListener("error",o),i.send(r)},aviaryUploadImage:function(t,n){var r=new FormData,i,s="https://up.flickr.com/services/upload",o,u,a=this;t.target.get("parentNode").addClass("balls"),t.target.get("parentNode").append("<span>"+this.intlMessage({intlName:"common.SAVING"})+"...</span>"),r.append("api_key",e.config.flickr.api.site_key),r.append("csrf",e.config.flickr
.csrf.token),r.append("external_image_link",n),r.append("clone_meta_from_photo_id",a.photoId),i=new XMLHttpRequest,i.open("POST",s,!0),i.withCredentials=!0,o=function(t){var n=typeof t=="object"?t.target.statusText:t+"";a.appContext.error("[feather-aviary-view] aviary-edit: Error during Aviary edited image upload ("+n+")"),a.onError(a.intlMessage({intlName:"errors.ERROR_SAVING"})),e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.upload.failure",title:"Upload API Failure"},e.url("/beacon_flanal_reboot_event.gne"))})},u=function(t){var n,r,i,s,u=a.get("photo").getValue("owner");try{i=document.createElement("div"),i.innerHTML=t.target.responseText,r=i.getElementsByTagName("rsp")[0]||"",r&&(r=r.getAttribute("stat")||""),s=i.getElementsByTagName("photoid")[0].innerHTML||"",n=i.getElementsByTagName("err")[0]||"",n&&(n=n.getAttribute("msg")||"")}catch(f){r="",n=""}if(r!=="ok")return o((r||"empty")+": "+(n||"no message"));e.use("rrd",function(e){e.RRD.queue({event:"flickr.hermes.upload.success",title:"Aviary upload as a new Image successful"},e.url("/beacon_flanal_reboot_event.gne"))}),window.location="/photos/"+(u.getValue("pathAlias")||u.getValue("nsid"))+"/"+s},i.addEventListener("load",u),i.addEventListener("error",o),i.send(r)},saveFromAviary:function(t){var n=this,r,i,s;r=this.templates("feather-aviary-save-dialog")({}),i=new e.Views["confirmation-dialog-view"]({photoID:this.photoId,appContext:this.appContext,title:this.intlMessage({intlName:"aviary.SAVE_PHOTO"}),content:r,confirmButtonClass:"hidden"}),i.render(),i.activate(),s=i.get("container"),i.registerEventHandler(s.one(".aviary-upload").on("click",n.aviaryUploadImage.bind(n),n,t)),i.registerEventHandler(s.one(".aviary-replace").on("click",n.aviaryReplaceImage,n,t)),this.fire("subviewViewEvent","getDialogOffset",function(t){n.aviarySaveDialog=e.Views.dialog.getNewInstance("dialog-modal",{content:i.get("container"),appContext:n.appContext,offsetLeft:t,dialogClass:"scrappy-dialog aviary-save-dialog"}),n.aviarySaveDialog.show()}),i.registerEventHandler(s.one(".cancel-confirmation").on("click",function(){n.aviarySaveDialog.close()}))},activate:function(){var t=this,n=window.YUI_config.groups.hermes.base,r,i=n+"html/feather_aviary.html",s,o,u,a,f=e.one("body");e.one(".aviary-dialog")&&e.one(".aviary-dialog").remove(!0);try{o=parseInt(this.get("photo").getValue("sizes").o.width,10),u=parseInt(this.get("photo").getValue("sizes").o.height,10),a=o*u/1e6}catch(l){}return a&&a<50?(t.aviaryDialog=e.Views.dialog.getNewInstance("dialog-modal",{content:'<iframe id="aviary-iframe"></iframe>',appContext:t.appContext,dialogClass:"scrappy-dialog aviary-dialog"}),t.aviaryDialog.show(),r=t.aviaryDialog.get("container").one("#aviary-iframe"),r.setAttribute("seamless","seamless"),r.setAttribute("frameborder","0"),r.setAttribute("scrolling","no"),r.setAttribute("marginheight","0"),r.setAttribute("marginwidth","0"),r.set("src",i),e.one(".aviary-dialog").setStyles({marginLeft:-((f.get("winWidth")-50)/2),marginTop:-((f.get("winHeight")-100)/2)}),r.setStyles({width:f.get("winWidth")-100,height:f.get("winHeight")-100}),s=r.getDOMNode().contentWindow,t.handShakeIntervalRef=setInterval(function(){try{s.postMessage("Is the iFrame ready?","https://s.yimg.com")}catch(e){}},200),t.iframeTimeoutRef=setTimeout(function(){t.handShakeIntervalRef&&(clearInterval(t.handShakeIntervalRef),t.onError(t.intlMessage({intlName:"aviary.ERROR"})))},2e4),e.config.win.addEventListener("message",t.responseFromAviaryFrame.bind(t),!1)):a?t.onError(t.intlMessage({intlName:"aviary.IMAGE_TOO_LARGE"})):t.onError(t.intlMessage({intlName:"aviary.NO_ORIGINAL_PHOTO"})),!1},onError:function(t){var n=this;this.fire("subviewViewEvent","getDialogOffset",function(r){var i=e.Views.dialog.getNewInstance("dialog-alert",{content:t,attrs:{title:n.intlMessage({intlName:"common.ERROR"}),level:"warning",confirmLabel:n.intlMessage({intlName:"common.OK"})},parent:n,offsetLeft:r,dialogClass:"scrappy-dialog"});i.show()})},destructor:function(){this.handShakeIntervalRef&&clearInterval(this.handShakeIntervalRef),this.iframeTimeoutRef&&clearTimeout(this.iframeTimeoutRef),this.handShakeIntervalRef=null,this.iframeTimeoutRef=null,this.aviaryDialog&&this.aviaryDialog.close()}})},"@VERSION@",{requires:["flickr-view","feather","url-helper","dialog","confirmation-dialog-view","flickr-promise","hermes-template-feather-aviary-save-dialog","fluid-balls-css","fluid-modal-view"],langBundles:["common","aviary","errors"],optional:[]});
YUI.add("hermes-lang-aviary",function(e,t){e.Intl.add("hermes/aviary","en-US",{SAVE:["Save a new copy"],SAVE_PHOTO:["Save this photo"],ERROR:["An error has occurred using Aviary. Please try again."],ENHANCE:["Enhance"],IMAGE_TOO_LARGE:["Sorry, but this image is too large to be edited. Please try again with an image that is less than 50 megapixels."],NO_ORIGINAL_PHOTO:["Unable to get the original photo. Please try again."],RETRY_DIALOG_MESSAGE:["This is taking longer than usual. Would you like to retry saving your changes?"]})},"@VERSION@",{requires:["intl"]});
YUI.add("hermes-lang-errors",function(e,t){e.Intl.add("hermes/errors","en-US",{UNAUTHORIZED_ACCESS:["Unauthorized Access"],YOU_ARE_NOT_AUTHORIZED:["You have attempted to access a page for which you are not authorized."],AUTO_REDIRECT_IN_10_SECONDS:["This page will automatically redirect to the Flickr home page in 10 seconds,"],OR_CLICK_LINK_FOR_HOME:["or click the following link to go straight to the <a href='/'>home page</a>."],ERROR:["Error"],ERROR_HAS_OCCURRED:["An error has occurred. Please try again."],ERROR_REPLACING:["An error has occurred replacing the image. Please try again."],ERROR_SAVING:["An error has occurred saving the image. Please try again."]})},"@VERSION@",{requires:["intl"]});
YUI.add("hermes-template-scrappy-edit-button",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function f(e,t){var r="",i,s;return r+='\n	<div class=\'edit\'>\n		<a href="#" title="',s={hash:{intlName:"photo-page-scrappy.EDIT_PHOTO"},data:t},r+=u((i=n.intlMessage||e.intlMessage,i?i.call(e,s):o.call(e,"intlMessage",s)))+'" class="button">\n			<i class="ui-icon-edit"></i>\n		</a>\n	</div>\n',r}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s,o=n.helperMissing,u=this.escapeExpression,a=this;return s=n["if"].call(t,t.viewerIsOwner,{hash:{},inverse:a.noop,fn:a.program(1,f,i),data:i}),s||s===0?s:""}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/scrappy-edit-button",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-scrappy-edit-menu",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function l(e,t){var r="",i,s;r+="\n		",i=n["if"].call(e,e.enableEditInAviary,{hash:{},inverse:f.program(4,h,t),fn:f.program(2,c,t),data:t});if(i||i===0)r+=i;return r+="\n			",s={hash:{intlName:"aviary.ENHANCE"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"\n			</a></li>\n		",r}function c(e,t){return'\n			<li><a href="#" class="edit-aviary">\n		'}function h(e,t){var r="",i;r+='\n			<li><a href="#" class="unavailable-feature ',i=n["if"].call(e,e.isVideo,{hash:{},inverse:f.noop,fn:f.program(5,p,t),data:t});if(i||i===0)r+=i;r+='" ',i=n["if"].call(e,e.isVideo,{hash:{},inverse:f.noop,fn:f.program(7,d,t),data:t});if(i||i===0)r+=i;return r+=">\n		",r}function p(e,t){return"isVideo"}function d(e,t){var r="",i,s;return r+='title="',s={hash:{intlName:"photo-page-scrappy.NO_VIDEOS_IN_AVIARY"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+'"}}"',r}function v(e,t){var r="",i,s;r+='\n		<li><a href="#" class="rotate-photo ',i=n["if"].call(e,e.isVideo,{hash:{},inverse:f.noop,fn:f.program(10,m,t),data:t});if(i||i===0)r+=i;r+='" ',i=n["if"].call(e,e.isVideo,{hash:{},inverse:f.noop,fn:f.program(12,g,t),data:t});if(i||i===0)r+=i;return r+=">\n			",s={hash:{intlName:"photo-page-scrappy.ROTATE"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"\n		</a></li>\n	",r}function m(e,t){return"isVideo unavailable-feature"}function g(e,t){var r="",i,s;return r+='title="',s={hash:{intlName:"photo-page-scrappy.NO_VIDEO_ROTATION"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+'"',r}function y(e,t){var r="",i,s;r+='\n		<li><a href="#" class="replace-photo ',i=n["if"].call(e,e.isVideo,{hash:{},inverse:f.noop,fn:f.program(10,m,t),data:t});if(i||i===0)r+=i;r+='" ',i=n["if"].call(e,e.isVideo,{hash:{},inverse:f.noop,fn:f.program(15,b,t),data:t});if(i||i===0)r+=i;return r+=">\n			",s={hash:{intlName:"photo-page-scrappy.REPLACE"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"\n		</a></li>\n	",r}function b(e,t){var r="",i,s;return r+='title="',s={hash:{intlName:"photo-page-scrappy.NO_VIDEO_REPLACE"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+'"',r}function w(e,t){var r="",i,s;return r+='\n		<li><a href="#" class="delete-photo">\n			',s={hash:{intlName:"common.DELETE"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"\n		</a></li>\n	",r}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u=n.helperMissing,a=this.escapeExpression,f=this;s+="<ul>\n\n	\n	",o=n["if"].call(t,t.showEditInAviaryLink,{hash:{},inverse:f.noop,fn:f.program(1,l,i),data:i});if(o||o===0)s+=o;s+="\n\n	",o=n["if"].call(t,t.showRotateLink,{hash:{},inverse:f.noop,fn:f.program(9,v,i),data:i});if(o||o===0)s+=o;s+="\n\n	",o=n["if"].call(t,t.showReplaceLink,{hash:{},inverse:f.noop,fn:f.program(14,y,i),data:i});if(o||o===0)s+=o;s+="\n\n	\n\n	",o=n["if"].call(t,t.showDeleteLink,{hash:{},inverse:f.noop,fn:f.program(17,w,i),data:i});if(o||o===0)s+=o;return s+="\n\n</ul>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/scrappy-edit-menu",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("photo-well-scrappy-edit-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){this.nsid=e.nsid,this.photoId=e.photoId,this.closeUrl=e.closeUrl;if(this.get("container").get("innerHTML")===""){var t=this.templates("scrappy-edit-button")({loadingView:!0});this.setContainerHTML(t)}return this},subviewConfig:{"feather-aviary-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1}},loadState:function(){var e=this;return this.appContext.getModel("photo-models",e.photoId).then(function(t){e.set("photo",t)})},buildContainer:function(){var e,t=this.get("photo").getValue("owner").getValue("isMe");return e=this.templates("scrappy-edit-button")({viewerIsOwner:t}),this.setContainerHTML(e),this},setupDropdown:function(){var t=this.get("container"),n=this.get("photo"),r,i=n.getValue("owner").getValue("isMe"),s=t,o,u=!1,a=!1,f=n.getValue("isVideo"),l=n.getValue("id"),c=this;this.appContext.flipper.isFlipped("turn-off-aviary")&&(a=!0),this.appContext.flipper.isFlipped("aviary")&&i&&(u=!0),r=e.URLHelper.getPhotoPage({photoId:n.getValue("id"),pathAlias:n.getValue("owner").getValue("pathAlias")}),o=this.templates("scrappy-edit-menu")({photoURL:r,photoId:l,viewerIsOwner:i,showDeleteLink:i,showRotateLink:i&&!f,showReplaceLink:i&&!f,isVideo:f,showEditInAviaryLink:i&&!f&&!a,enableEditInAviary:u}),this.editMenu=e.Views.dialog.getNewInstance("dialog-tooltip",{content:o,anchorTo:s,dropUp:!0,parent:this,positioning:!1,rootEl:t}),this.editMenu.render(),this.editMenu.on("toggle",function(e){e&&e.details&&e.details.length>0&&(e.details[0]?c.fire("subviewViewEvent","make in view",t):c.fire("subviewViewEvent","close in view"))})},handleMenuButtonClick:function(t){t.preventDefault(),e.rapidTracker.beacon(this.name,"editMenuClick"),this.editMenu.toggle()},handleDeletePhotoClick:function(t){t.preventDefault();var n,r,i=this;this.editMenu.hide(),n=new e.Views["confirmation-dialog-view"]({photoID:this.photoId,appContext:this.appContext,title:this.intlMessage({intlName:"photo-page-scrappy.DELETE_PHOTO"}),content:this.intlMessage({intlName:"photo-page-scrappy.PERMANTENTLY_DELETE"}),confirmButtonLabel:this.intlMessage({intlName:"common.DELETE"}),confirmButtonClass:"ui-dialog-button-negative"}),n.render(),n.activate(),r=n.get("container"),n.registerEventHandler(r.one(".ui-dialog-button-confirm").on("click",this.handleDeletePhotoConfirmClick,this)),n.registerEventHandler(r.one(".ui-dialog-button-close").on("click",function(){i.deleteDialog.close()})),this.fire("subviewViewEvent","getDialogOffset",function(t){i.deleteDialog=e.Views.dialog.getNewInstance("dialog-modal",{content:n.get("container"),appContext:i.appContext,offsetLeft:t,dialogClass:"scrappy-dialog"}),i.deleteDialog.show()}),e.rapidTracker.beacon(this.name,"deletePhotoClick")},handleDeletePhotoConfirmClick:function(t){var n=this;e.rapidTracker.beacon(this.name,"deletePhotoConfirmationClick"),n.deleteDialog.close(),n.deleteDialog.destroy(),this.appContext.flickrAPI.callMethod("flickr.photos.delete",{photo_id:this.photoId}).then(function(e){var t=n.get("photo").getValue("owner");window.location="/photos/"+(t.getValue("pathAlias")||t.getValue("nsid"))+"/?deleted="+n.photoId},function(e){n.onError()})},handleReplacePhotoClick:function(t){t.halt();var n=this.get("container"),r=this,i=this.get("photo").getValue("isVideo");if(i)return;this.editMenu.hide(),this.fire("subviewViewEvent","getDialogOffset",function(t){r.replaceDialog=e.Views.dialog.getNewInstance("dialog-cta",{id:"replace-"+r.photoId,attrs:{},template:"dialog-cta-reboot",content:r.templates("replace-photo-dialog-content"),parent:r,photoTitle:r.get("photo").getValue("title"),username:r.get("photo").getValue("owner").getValue("displayname"),rootEl:n.ancestor(".photo-page-scrappy-view"),offsetLeft:t,dialogClass:"scrappy-dialog"}),r.replaceDialog.attachEvents({"input change:":function(e){e.halt();var t=e.target.getDOMNode().files[0];if(!t)return;r._imgFile=t,r.replaceConfirm()},":submit":function(){r.replaceSubmit()}}),r.replaceDialog.on("hide",function(){r._imgFileXhr&&r._imgFileXhr.abort(),r._imgFileXhr=null,r._imgFile=null,r.replaceDialog.destroy(),r.replaceDialog=null}),r.replaceDialog.show()}),e.rapidTracker.beacon(this.name,"replacePhotoClick")},replaceConfirm:function(){this.replaceDialog.set("fileName",this._imgFile.name),this.replaceDialog.renderContent({photoTitle:this.get("photo").getValue("title"),username:this.get("photo").getValue("owner").getValue("displayname")}),e.rapidTracker.beacon(this.name,"replacePhotoConfirmationClick")},replaceSubmit:function(){var t=new FormData,n=this,r,i,s="https://up.flickr.com/services/replace",o,u,a;this.replaceDialog.set("uploading",!0),this.replaceDialog.renderContent(),this.replaceDialog.switchToWorking(),t.append("api_key",e.config.flickr.api.site_key),t.append("csrf",e.config.flickr.csrf.token),t.append("photo",this._imgFile,this._imgFile.name),t.append("photo_id",this.photoId),r=this._imgFileXhr=new XMLHttpRequest,r.open("POST",s,!0),r.withCredentials=!0,u=function(e){var t=typeof e=="object"?e.target.statusText:e+"";n.replaceDialog.switchToWorking(!1),n.replaceDialog.set("error",!0),n.replaceDialog.renderContent(),n.appContext.error("[more-menu-view] photo-replace: error during upload ("+t+")")},a=function(e){var t,r,i;try{i=document.createElement("div"),i.innerHTML=e.target.responseText,r=i.getElementsByTagName("rsp")[0]||"",r&&(r=r.getAttribute("stat")||""),t=i.getElementsByTagName("err")[0]||"",t&&(t=t.getAttribute("msg")||"")}catch(s){r="",t=""}if(r!=="ok")return u((r||"empty")+": "+(t||"no message"));n.replaceDialog.close(),document.location.reload()},r.addEventListener("load",a),r.addEventListener("error",u),o=n.replaceDialog.get("container").one("progress").getDOMNode(),r.upload.addEventListener("progress",function(e){o.value=i=Math.floor(100*(e.loaded/e.total)),e.loaded===e.total&&o.removeAttribute("value")}),r.send(t)},handleRotatePhotoClick:function(t){t.halt();var n=this,r=240
,i=this.get("photo").getValue("isVideo");if(i)return;this.editMenu.hide(),this.fire("subviewViewEvent","getDialogOffset",function(t){n.rotateDialog=e.Views.dialog.getNewInstance("dialog-cta",{id:"rotate-"+n.photoId,attrs:{},template:"dialog-cta-reboot",content:n.templates("rotate-photo-dialog-content"),parent:n,offsetLeft:t,dialogClass:"scrappy-dialog"}),n.rotateDialog.attachEvents({":select":function(t,r){n.rotateDialog.switchToLocked(!1),t.target.ancestor(".c-rotations").all("img").removeClass("c-state-selected"),t.target.addClass("c-state-selected"),n._imgRotation=e.flutil.constrainToValues(r.rotation,["90","180","270"])},":submit":function(){n.rotateSubmit()}}),n.rotateDialog.on("hide",function(){n.rotateDialog.destroy(),n.rotateDialog=null}),n.rotateDialog.set("preview",n.get("photo").getSizeToFit({width:r,height:r})),n.rotateDialog.switchToLocked(),n.rotateDialog.show()}),e.rapidTracker.beacon(this.name,"rotatePhotoClick")},rotateSubmit:function(){var t=this;e.one(".c-button-rotate").addClass("disabled"),e.rapidTracker.beacon(this.name,"rotatePhotoConfirmationClick"),this.appContext.flickrAPI.callMethod("flickr.photos.transform.rotate",{photo_id:this.photoId,degrees:this._imgRotation}).then(function(){setTimeout(function(){t.rotateDialog.close(),document.location.reload()},2e3)},function(n){e.one(".c-button-rotate").removeClass("disabled"),t.rotateDialog.set("error",!0),t.rotateDialog.renderContent(),t.appContext.error("[more-menu-view] photo-rotate: error during rotation ("+n.toString()+")")})},handleEditAviaryClick:function(t){t.halt(),this.editMenu.hide();if(this.appContext.flipper.isFlipped("enable-aviary-feather")){var n=this.subviews["feather-aviary-view"];n&&n.activate()}else this.aviary=new e.Views.scrappyAviary({attrs:{},photo:this.get("photo"),appContext:this.appContext}),this.aviary.show(),this.on("destroy",function(){self.aviary.destroy()});e.rapidTracker.beacon(this.name,"editAviary")},activate:function(){var e=this,t=this.get("container"),n,r={};return this.appContext.experiments.fullscreen.getMode()||(this.setupDropdown(),n=e.editMenu.get("container")),t&&this.registerEventHandler(t.on("click",e.handleMenuButtonClick,e)),this.appContext.experiments.fullscreen.getMode()||this.appContext.auth.signedIn&&(r.deleteMenuItem=n.one(".delete-photo"),r.deleteMenuItem&&r.deleteMenuItem.on("click",e.handleDeletePhotoClick,e),r.rotateMenuItem=n.one(".rotate-photo"),r.rotateMenuItem&&r.rotateMenuItem.on("click",e.handleRotatePhotoClick,e),r.replaceMenuItem=n.one(".replace-photo"),r.replaceMenuItem&&r.replaceMenuItem.on("click",e.handleReplacePhotoClick,e),r.aviaryMenuItem=n.one(".edit-aviary"),r.aviaryMenuItem&&r.aviaryMenuItem.on("click",e.handleEditAviaryClick,e)),this}})},"@VERSION@",{requires:["flickr-view","dialog","flutil","hermes-template-dialog-cta-reboot","flickr-promise","scrappy-aviary","feather-aviary-view","confirmation-dialog-view","hermes-template-scrappy-edit-button","hermes-template-scrappy-edit-menu","hermes-template-delete-photo-dialog-content","hermes-template-replace-photo-dialog-content","hermes-template-rotate-photo-dialog-content","photo-well-scrappy-edit-view-css"],optional:[],langBundles:["common","photo-page-scrappy","aviary"]});
YUI.add("hermes-template-sub-photo-tags",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return u={hash:{},data:i},s+=f((o=n.outlet||t.outlet,o?o.call(t,t.tags,u):a.call(t,"outlet",t.tags,u)))+"\n\n",u={hash:{},data:i},s+=f((o=n.outlet||t.outlet,o?o.call(t,t.people,u):a.call(t,"outlet",t.people,u)))+'\n\n<div style="clear: both;"></div>',s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-tags",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("sub-photo-tags-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},subviewConfig:{"sub-photo-tags-tag-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:[""]},"photo-charm-tags-autotag-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:[""],disabled:function(){return!this.appContext.flipper.isFlipped("auto-tags")}},"sub-photo-tags-people-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:[""],disabled:function(){return!this.appContext.flipper.isFlipped("people-tagging")}}},loadState:function(){return e.Promise.resolve()},buildContainer:function(){var e;return e=this.templates("sub-photo-tags")({tags:this.subviews["sub-photo-tags-tag-view"]?this.subviews["sub-photo-tags-tag-view"].get("container"):"",autotags:this.subviews["photo-charm-tags-autotag-view"]?this.subviews["photo-charm-tags-autotag-view"].get("container"):"",people:this.subviews["sub-photo-tags-people-view"]?this.subviews["sub-photo-tags-people-view"].get("container"):""}),this.setContainerHTML(e),this},activate:function(){var t=this;return this.registerEventHandler(e.on("flickr:photo-page:focus_person_tag_entry",function(e){t.subviews["sub-photo-tags-people-view"]&&(t.subviews["sub-photo-tags-people-view"].focus=!0,t.subviews["sub-photo-tags-people-view"].focusTag())})),this}})},"@VERSION@",{requires:["flickr-view","hermes-template-sub-photo-tags","photo-charms-tags-css"],optional:[],langBundles:["common","photo-page-scrappy"]});
